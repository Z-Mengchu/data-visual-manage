<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.ruoyi.sales.mapper.ChannelSalesDataVisualMapper">

    <!-- 筛选条件选项查询 -->
    <select id="selectFilterOptions" resultType="java.util.Map">
        SELECT
            (SELECT GROUP_CONCAT(DISTINCT country) FROM channel_sales_data WHERE country IS NOT NULL
                <!-- 根据岗位进行数据权限过滤 -->
                <include refid="postDataFilter"/>
             ) as countries
    </select>

    <!-- 带权限的核心KPI数据查询 -->
    <select id="selectKpiDataWithPermission" resultType="java.util.Map">
        SELECT
        SUM(revenue_rmb) as totalRevenue,
        SUM(order_gross_profit) as totalGrossProfit,
        SUM(order_net_profit) as totalNetProfit,
        CASE
        WHEN SUM(revenue_rmb) = 0 THEN 0
        ELSE SUM(order_gross_profit) / SUM(revenue_rmb)
        END as grossProfitRate,
        CASE
        WHEN SUM(revenue_rmb) = 0 THEN 0
        ELSE SUM(order_net_profit) / SUM(revenue_rmb)
        END as netProfitRate,
        CASE
        WHEN SUM(product_cost + first_mile_shipping) = 0 THEN 0
        ELSE SUM(order_net_profit) / SUM(product_cost + first_mile_shipping)
        END as avgRoi
        FROM channel_sales_data
        <where>
            revenue_rmb IS NOT NULL
            <if test="data.startTime != null">
                AND payment_settlement_date &gt;= #{data.startTime}
            </if>
            <if test="data.endTime != null">
                AND payment_settlement_date &lt;= #{data.endTime}
            </if>
            <if test="data.country != null and data.country != ''">
                AND country = #{data.country}
            </if>
            <!-- 根据岗位进行数据权限过滤 -->
            <include refid="postDataFilter"/>
        </where>
    </select>
    <!-- 带权限的品类退款率数据查询 -->
    <select id="selectCategoryRefundDataWithPermission" resultType="java.util.Map">
        SELECT
        category,
        SUM(revenue_rmb) as revenue,
        SUM(refund) as refundAmount,
        CASE
        WHEN SUM(revenue_rmb) = 0 THEN 0
        ELSE SUM(refund) / SUM(revenue_rmb)
        END as refundRate
        FROM channel_sales_data
        <where>
            revenue_rmb IS NOT NULL
            <if test="data.startTime != null">
                AND payment_settlement_date &gt;= #{data.startTime}
            </if>
            <if test="data.endTime != null">
                AND payment_settlement_date &lt;= #{data.endTime}
            </if>
            <if test="data.country != null and data.country != ''">
                AND country = #{data.country}
            </if>
            <!-- 根据岗位进行数据权限过滤 -->
            <include refid="postDataFilter"/>
        </where>
        GROUP BY category
        ORDER BY revenue DESC
    </select>

    <!-- 带权限的SKU ROI数据查询 -->
    <select id="selectSkuRoiDataWithPermission" resultType="java.util.Map">
        SELECT
        tongtu_sku as tongtuSku,
        product_name as productName,
        SUM(shipping_quantity) as shippingQuantity,
        SUM(product_cost) as productCost,
        SUM(first_mile_shipping) as firstMileShipping,
        SUM(order_net_profit) as orderNetProfit,
        CASE
        WHEN SUM(product_cost + first_mile_shipping) = 0 THEN 0
        ELSE SUM(order_net_profit) / SUM(product_cost + first_mile_shipping)
        END as roi,
        AVG(days_to_positive_cash_flow) as daysToPositiveCashFlow
        FROM channel_sales_data
        <where>
            <if test="data.startTime != null">
                AND payment_settlement_date &gt;= #{data.startTime}
            </if>
            <if test="data.endTime != null">
                AND payment_settlement_date &lt;= #{data.endTime}
            </if>
            <if test="data.country != null and data.country != ''">
                AND country = #{data.country}
            </if>
            <!-- 根据岗位进行数据权限过滤 -->
            <include refid="postDataFilter"/>
        </where>
        GROUP BY tongtu_sku, product_name
        HAVING SUM(shipping_quantity) > 0
        ORDER BY orderNetProfit DESC
    </select>

    <!-- 一级品类数据查询 -->
    <select id="selectFirstLevelCategoryDataWithPermission" resultType="java.util.Map">
        SELECT
        first_level_category as firstLevelCategory,
        SUM(revenue_rmb) as revenue,
        SUM(order_gross_profit) as orderGrossProfit,
        SUM(order_net_profit) as orderNetProfit,
        CASE
        WHEN SUM(product_cost + first_mile_shipping) = 0 THEN 0
        ELSE SUM(order_net_profit) / SUM(product_cost + first_mile_shipping)
        END as roi,
        AVG(days_to_positive_cash_flow) as daysToPositiveCashFlow
        FROM channel_sales_data
        <where>
            <if test="data.startTime != null">
                AND payment_settlement_date &gt;= #{data.startTime}
            </if>
            <if test="data.endTime != null">
                AND payment_settlement_date &lt;= #{data.endTime}
            </if>
            <if test="data.country != null and data.country != ''">
                AND country = #{data.country}
            </if>
            <!-- 根据岗位进行数据权限过滤 -->
            <include refid="postDataFilter"/>
        </where>
        GROUP BY first_level_category
        ORDER BY revenue DESC
    </select>
    <!-- 渠道数据查询 -->
    <select id="selectChannelDataWithPermission" resultType="java.util.Map">
        SELECT
        channel,
        SUM(revenue_rmb) as revenue,
        SUM(order_gross_profit) as orderGrossProfit,
        CASE
        WHEN SUM(revenue_rmb) = 0 THEN 0
        ELSE SUM(order_gross_profit) / SUM(revenue_rmb)
        END as grossProfitRate,
        SUM(order_net_profit) as orderNetProfit,
        CASE
        WHEN SUM(revenue_rmb) = 0 THEN 0
        ELSE SUM(order_net_profit) / SUM(revenue_rmb)
        END as netProfitRate,
        CASE
        WHEN SUM(product_cost + first_mile_shipping) = 0 THEN 0
        ELSE SUM(order_net_profit) / SUM(product_cost + first_mile_shipping)
        END as roi,
        AVG(days_to_positive_cash_flow) as daysToPositiveCashFlow
        FROM channel_sales_data
        <where>
            revenue_rmb IS NOT NULL
            <if test="data.startTime != null">
                AND payment_settlement_date &gt;= #{data.startTime}
            </if>
            <if test="data.endTime != null">
                AND payment_settlement_date &lt;= #{data.endTime}
            </if>
            <if test="data.country != null and data.country != ''">
                AND country = #{data.country}
            </if>
            <!-- 根据岗位进行数据权限过滤 -->
            <include refid="postDataFilter"/>
        </where>
        GROUP BY channel
        ORDER BY revenue DESC
    </select>
    <!-- 品牌数据查询 -->
    <select id="selectBrandDataWithPermission" resultType="java.util.Map">
        SELECT
        brand,
        SUM(revenue_rmb) as revenue,
        SUM(order_gross_profit) as orderGrossProfit,
        CASE
        WHEN SUM(revenue_rmb) = 0 THEN 0
        ELSE SUM(order_gross_profit) / SUM(revenue_rmb)
        END as grossProfitRate,
        SUM(order_net_profit) as orderNetProfit,
        CASE
        WHEN SUM(revenue_rmb) = 0 THEN 0
        ELSE SUM(order_net_profit) / SUM(revenue_rmb)
        END as netProfitRate,
        CASE
        WHEN SUM(product_cost + first_mile_shipping) = 0 THEN 0
        ELSE SUM(order_net_profit) / SUM(product_cost + first_mile_shipping)
        END as roi,
        AVG(days_to_positive_cash_flow) as daysToPositiveCashFlow
        FROM channel_sales_data
        <where>
            revenue_rmb IS NOT NULL
            <if test="data.startTime != null">
                AND payment_settlement_date &gt;= #{data.startTime}
            </if>
            <if test="data.endTime != null">
                AND payment_settlement_date &lt;= #{data.endTime}
            </if>
            <if test="data.country != null and data.country != ''">
                AND country = #{data.country}
            </if>
            <!-- 根据岗位进行数据权限过滤 -->
            <include refid="postDataFilter"/>
        </where>
        GROUP BY brand
        HAVING brand IS NOT NULL AND brand != ''
        ORDER BY revenue DESC
    </select>
    <!-- 国家数据查询 -->
    <select id="selectCountryDataWithPermission" resultType="java.util.Map">
        SELECT
        country,
        SUM(revenue_rmb) as revenue,
        SUM(order_gross_profit) as orderGrossProfit,
        CASE
        WHEN SUM(revenue_rmb) = 0 THEN 0
        ELSE SUM(order_gross_profit) / SUM(revenue_rmb)
        END as grossProfitRate,
        SUM(order_net_profit) as orderNetProfit,
        CASE
        WHEN SUM(revenue_rmb) = 0 THEN 0
        ELSE SUM(order_net_profit) / SUM(revenue_rmb)
        END as netProfitRate,
        CASE
        WHEN SUM(product_cost + first_mile_shipping) = 0 THEN 0
        ELSE SUM(order_net_profit) / SUM(product_cost + first_mile_shipping)
        END as roi,
        AVG(days_to_positive_cash_flow) as daysToPositiveCashFlow
        FROM channel_sales_data
        <where>
            revenue_rmb IS NOT NULL
            <if test="data.startTime != null">
                AND payment_settlement_date &gt;= #{data.startTime}
            </if>
            <if test="data.endTime != null">
                AND payment_settlement_date &lt;= #{data.endTime}
            </if>
            <if test="data.country != null and data.country != ''">
                AND country = #{data.country}
            </if>
            <!-- 根据岗位进行数据权限过滤 -->
            <include refid="postDataFilter"/>
        </where>
        GROUP BY country
        HAVING country IS NOT NULL AND country != ''
        ORDER BY revenue DESC
    </select>
    <!-- 店铺数据查询 -->
    <select id="selectStoreDataWithPermission" resultType="java.util.Map">
        SELECT
        store_code as storeCode,
        channel_account as channelAccount,
        SUM(revenue_rmb) as revenue,
        SUM(order_gross_profit) as orderGrossProfit,
        CASE
        WHEN SUM(revenue_rmb) = 0 THEN 0
        ELSE SUM(order_gross_profit) / SUM(revenue_rmb)
        END as grossProfitRate,
        SUM(order_net_profit) as orderNetProfit,
        CASE
        WHEN SUM(revenue_rmb) = 0 THEN 0
        ELSE SUM(order_net_profit) / SUM(revenue_rmb)
        END as netProfitRate,
        CASE
        WHEN SUM(product_cost + first_mile_shipping) = 0 THEN 0
        ELSE SUM(order_net_profit) / SUM(product_cost + first_mile_shipping)
        END as roi,
        AVG(days_to_positive_cash_flow) as daysToPositiveCashFlow
        FROM channel_sales_data
        <where>
            revenue_rmb IS NOT NULL
            <if test="data.startTime != null">
                AND payment_settlement_date &gt;= #{data.startTime}
            </if>
            <if test="data.endTime != null">
                AND payment_settlement_date &lt;= #{data.endTime}
            </if>
            <if test="data.country != null and data.country != ''">
                AND country = #{data.country}
            </if>
            <!-- 根据岗位进行数据权限过滤 -->
            <include refid="postDataFilter"/>
        </where>
        GROUP BY store_code, channel_account
        HAVING store_code IS NOT NULL AND store_code != ''
        ORDER BY revenue DESC
    </select>
    <!-- 地图数据查询 -->
    <select id="selectMapDataWithPermission" resultType="java.util.Map">
        SELECT
        country,
        SUM(revenue_rmb) as revenue,
        SUM(order_net_profit) as orderNetProfit,
        CASE
        WHEN SUM(product_cost + first_mile_shipping) = 0 THEN 0
        ELSE SUM(order_net_profit) / SUM(product_cost + first_mile_shipping)
        END as roi,
        AVG(days_to_positive_cash_flow) as daysToPositiveCashFlow
        FROM channel_sales_data
        <where>
            <if test="data.startTime != null">
                AND payment_settlement_date &gt;= #{data.startTime}
            </if>
            <if test="data.endTime != null">
                AND payment_settlement_date &lt;= #{data.endTime}
            </if>
            <if test="data.country != null and data.country != ''">
                AND country = #{data.country}
            </if>
            <!-- 根据岗位进行数据权限过滤 -->
            <include refid="postDataFilter"/>
        </where>
        GROUP BY country
        HAVING country IS NOT NULL AND country != ''
        ORDER BY revenue DESC
    </select>
    <!-- 渠道销售额占比数据查询 -->
    <select id="selectChannelDistributionDataWithPermission" resultType="java.util.Map">
        SELECT
        channel,
        SUM(revenue_rmb) as revenue,
        ROUND(SUM(revenue_rmb) / (SELECT SUM(revenue_rmb) FROM channel_sales_data
        <where>
            <if test="data.startTime != null">
                AND payment_settlement_date &gt;= #{data.startTime}
            </if>
            <if test="data.endTime != null">
                AND payment_settlement_date &lt;= #{data.endTime}
            </if>
            <if test="data.country != null and data.country != ''">
                AND country = #{data.country}
            </if>
            <!-- 根据岗位进行数据权限过滤 -->
            <include refid="postDataFilter"/>
        </where>
        ) * 100, 2) as percentage
        FROM channel_sales_data
        <where>
            <if test="data.startTime != null">
                AND payment_settlement_date &gt;= #{data.startTime}
            </if>
            <if test="data.endTime != null">
                AND payment_settlement_date &lt;= #{data.endTime}
            </if>
            <if test="data.country != null and data.country != ''">
                AND country = #{data.country}
            </if>
            <!-- 根据岗位进行数据权限过滤 -->
            <include refid="postDataFilter"/>
        </where>
        GROUP BY channel
        ORDER BY revenue DESC
    </select>
    <!-- 预警数据查询 -->
    <select id="selectAlertDataWithPermission" resultType="java.util.Map">
        SELECT
        '高退款率' as alertType,
        category as item,
        CASE
        WHEN SUM(revenue_rmb) = 0 THEN 0
        ELSE SUM(refund) / SUM(revenue_rmb)
        END as value
        FROM channel_sales_data
        <where>
            revenue_rmb IS NOT NULL
            <if test="data.startTime != null">
                AND payment_settlement_date &gt;= #{data.startTime}
            </if>
            <if test="data.endTime != null">
                AND payment_settlement_date &lt;= #{data.endTime}
            </if>
            <if test="data.country != null and data.country != ''">
                AND country = #{data.country}
            </if>
            <!-- 根据岗位进行数据权限过滤 -->
            <include refid="postDataFilter"/>
        </where>
        GROUP BY category
        HAVING SUM(revenue_rmb) > 1000 AND SUM(refund) / SUM(revenue_rmb) > 0.1
        ORDER BY value DESC
        LIMIT 5
    </select>
    <!-- 趋势数据查询 -->
    <select id="selectTrendDataWithPermission" resultType="java.util.Map">
        SELECT
        DATE(payment_settlement_date) as date,
        SUM(revenue_rmb) as revenue,
        SUM(order_net_profit) as profit
        FROM channel_sales_data
        <where>
            <if test="data.startTime != null">
                AND payment_settlement_date &gt;= #{data.startTime}
            </if>
            <if test="data.endTime != null">
                AND payment_settlement_date &lt;= #{data.endTime}
            </if>
            <if test="data.country != null and data.country != ''">
                AND country = #{data.country}
            </if>
            <!-- 根据岗位进行数据权限过滤 -->
            <include refid="postDataFilter"/>
        </where>
        GROUP BY DATE(payment_settlement_date)
        ORDER BY date
    </select>
    <!-- 详情数据查询 -->
    <select id="selectDetailDataWithPermission" resultType="java.util.Map">
        SELECT
        tongtu_sku,
        product_name,
        channel,
        revenue_rmb as revenue,
        product_cost,
        first_mile_shipping,
        order_net_profit,
        roi,
        days_to_positive_cash_flow,
        CASE
        WHEN revenue_rmb = 0 THEN 0
        ELSE refund / revenue_rmb
        END as refundRate
        FROM channel_sales_data
        <where>
            <if test="data.startTime != null">
                AND payment_settlement_date &gt;= #{data.startTime}
            </if>
            <if test="data.endTime != null">
                AND payment_settlement_date &lt;= #{data.endTime}
            </if>
            <if test="data.country != null and data.country != ''">
                AND country = #{data.country}
            </if>
            <!-- 根据岗位进行数据权限过滤 -->
            <include refid="postDataFilter"/>
        </where>
        ORDER BY revenue_rmb DESC
        LIMIT 100
    </select>

    <sql id="postDataFilter">
        <!-- 数据权限过滤条件 -->
        <if test="user != null">
            <choose>
                <when test="roleKeys.size() > 0 and roleKeys.contains('admin')">
                    <!-- 超级管理员显示所有数据 -->
                </when>
                <when test="postCodes != null and postCodes.contains('general_leader')">
                    <!-- 大组长无数据限制 -->
                </when>
                <!-- 用户为组长级别 -->
                <when test="postCodes != null and (postCodes.contains('operation_leader') or postCodes.contains('development_leader'))">
                    and (
                    <if test="postCodes.contains('operation_leader') and user.operationGroupName != null and user.operationGroupName != ''">
                        operation_group_name = #{user.operationGroupName}
                    </if>
                    <if test="postCodes.contains('development_leader') and user.developmentGroupName != null and user.developmentGroupName != ''">       <if test="postCodes.contains('operation_leader') and user.operationGroupName != null and user.operationGroupName != ''"> OR </if>
                        development_group_name = #{user.developmentGroupName}
                    </if>
                    )
                </when>
                <!-- 用户为普通员工 -->
                <when test="postCodes != null and (postCodes.contains('operator') or postCodes.contains('developer'))">
                    and (
                    <trim prefixOverrides="OR">
                        <if test="postCodes.contains('operator') and user.userName != null and user.userName != ''">
                            operator = #{user.userName}
                        </if>
                        <if test="postCodes.contains('developer') and user.userName != null and user.userName != ''">
                            <if test="postCodes.contains('operator') and user.userName != null and user.userName != ''"> OR </if>
                            product_developer = #{user.userName}
                        </if>
                    </trim>
                    )
                </when>
                <!-- 防止用户随便增加一些董事长，经理之类的岗位，直接放行权限 -->
                <otherwise>
                </otherwise>
            </choose>
        </if>
    </sql>
</mapper>
