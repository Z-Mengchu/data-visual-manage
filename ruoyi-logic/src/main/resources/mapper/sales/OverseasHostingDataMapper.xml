<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ruoyi.sales.mapper.OverseasHostingDataMapper">

    <resultMap type="OverseasHostingData" id="OverseasHostingDataResult">
        <result property="id"    column="id"    />
        <result property="store"    column="store"    />
        <result property="settlementTime"    column="settlement_time"    />
        <result property="orderNumber"    column="order_number"    />
        <result property="productId"    column="product_id"    />
        <result property="brand"    column="brand"    />
        <result property="sku"    column="sku"    />
        <result property="category"    column="category"    />
        <result property="feeItem"    column="fee_item"    />
        <result property="amountCny"    column="amount_cny"    />
        <result property="platformTransactionNumber"    column="platform_transaction_number"    />
        <result property="limitedSupplyPriceTaskId"    column="limited_supply_price_task_id"    />
        <result property="revenue"    column="revenue"    />
        <result property="refund"    column="refund"    />
        <result property="allocationRatio"    column="allocation_ratio"    />
        <result property="purchaseCost"    column="purchase_cost"    />
        <result property="firstMileCost"    column="first_mile_cost"    />
        <result property="logisticsFee"    column="logistics_fee"    />
        <result property="packagingCost"    column="packaging_cost"    />
        <result property="otherCosts"    column="other_costs"    />
        <result property="reshipmentCost"    column="reshipment_cost"    />
        <result property="grossProfit"    column="gross_profit"    />
        <result property="grossProfitMargin"    column="gross_profit_margin"    />
        <result property="developer"    column="developer"    />
        <result property="operator"    column="operator"    />
        <result property="shippingWarehouse"    column="shipping_warehouse"    />
    </resultMap>
    <!-- 维度汇总结果映射 -->
    <resultMap type="OverseasHostingDimensionSummary" id="DimensionSummaryResult">
        <result property="groupValue"    column="group_value"    />
        <result property="revenueSum"    column="revenue_sum"    />
        <result property="refundSum"    column="refund_sum"    />
        <result property="purchaseCostSum"    column="purchase_cost_sum"    />
        <result property="firstMileCostSum"    column="first_mile_cost_sum"    />
        <result property="logisticsFeeSum"    column="logistics_fee_sum"    />
        <result property="packagingCostSum"    column="packaging_cost_sum"    />
        <result property="otherCostsSum"    column="other_costs_sum"    />
        <result property="reshipmentCostSum"    column="reshipment_cost_sum"    />
        <result property="grossProfitSum"    column="gross_profit_sum"    />
    </resultMap>
    <!-- 费用项汇总结果映射 -->
    <resultMap type="FeeItemSummary" id="FeeItemSummaryResult">
        <result property="feeItem"    column="fee_item"    />
        <result property="amountCnySum"    column="amount_cny_sum"    />
    </resultMap>

    <sql id="selectOverseasHostingDataVo">
        select id, store, settlement_time, order_number, product_id, brand, sku, category, fee_item, amount_cny, platform_transaction_number, limited_supply_price_task_id, revenue, refund, allocation_ratio, purchase_cost, first_mile_cost, logistics_fee, packaging_cost, other_costs, reshipment_cost, gross_profit, gross_profit_margin, developer, operator, shipping_warehouse from overseas_hosting_data
    </sql>

    <select id="selectOverseasHostingDataList" parameterType="OverseasHostingData" resultMap="OverseasHostingDataResult">
        <include refid="selectOverseasHostingDataVo"/>
        <where>
            <if test="store != null and store != ''"> and store = #{store}</if>
            <if test="params.beginSettlementTime != null and params.beginSettlementTime != '' and params.endSettlementTime != null and params.endSettlementTime != ''"> and settlement_time between #{params.beginSettlementTime} and #{params.endSettlementTime}</if>
            <if test="orderNumber != null  and orderNumber != ''"> and order_number = #{orderNumber}</if>
            <if test="productId != null and productId != ''"> and product_id = #{productId}</if>
            <if test="brand != null  and brand != ''"> and brand = #{brand}</if>
            <if test="sku != null  and sku != ''"> and sku = #{sku}</if>
            <if test="category != null  and category != ''"> and category = #{category}</if>
            <if test="feeItem != null  and feeItem != ''"> and fee_item = #{feeItem}</if>
            <if test="amountCny != null "> and amount_cny = #{amountCny}</if>
            <if test="platformTransactionNumber != null  and platformTransactionNumber != ''"> and platform_transaction_number = #{platformTransactionNumber}</if>
            <if test="limitedSupplyPriceTaskId != null  and limitedSupplyPriceTaskId != ''"> and limited_supply_price_task_id = #{limitedSupplyPriceTaskId}</if>
            <if test="revenue != null "> and revenue = #{revenue}</if>
            <if test="refund != null "> and refund = #{refund}</if>
            <if test="allocationRatio != null "> and allocation_ratio = #{allocationRatio}</if>
            <if test="purchaseCost != null "> and purchase_cost = #{purchaseCost}</if>
            <if test="firstMileCost != null "> and first_mile_cost = #{firstMileCost}</if>
            <if test="logisticsFee != null "> and logistics_fee = #{logisticsFee}</if>
            <if test="packagingCost != null "> and packaging_cost = #{packagingCost}</if>
            <if test="otherCosts != null "> and other_costs = #{otherCosts}</if>
            <if test="reshipmentCost != null "> and reshipment_cost = #{reshipmentCost}</if>
            <if test="grossProfit != null "> and gross_profit = #{grossProfit}</if>
            <if test="grossProfitMargin != null "> and gross_profit_margin = #{grossProfitMargin}</if>
            <if test="developer != null  and developer != ''"> and developer = #{developer}</if>
            <if test="operator != null  and operator != ''"> and operator = #{operator}</if>
            <if test="shippingWarehouse != null  and shippingWarehouse != ''"> and shipping_warehouse = #{shippingWarehouse}</if>
        </where>
    </select>

    <select id="selectOverseasHostingDataByOrderNumber" resultMap="OverseasHostingDataResult">
        <include refid="selectOverseasHostingDataVo"/>
        <where>
            <if test="orderNumber != null and orderNumber != ''"> and order_number = #{orderNumber}</if>
            <if test="orderNumber == null"> and order_number is null </if>
        </where>
    </select>

    <select id="selectOverseasHostingDataListWithPermission" parameterType="map" resultMap="OverseasHostingDataResult">
        <include refid="selectOverseasHostingDataVo"/>
        <where>
            <if test="data.store != null and data.store != ''"> and store = #{data.store}</if>
            <if test="data.params.beginSettlementTime != null and data.params.beginSettlementTime != '' and data.params.endSettlementTime != null and data.params.endSettlementTime != ''"> and settlement_time between #{data.params.beginSettlementTime} and #{data.params.endSettlementTime}</if>
            <if test="data.orderNumber != null  and data.orderNumber != ''"> and order_number = #{data.orderNumber}</if>
            <if test="data.productId != null  and data.productId != ''"> and product_id = #{data.productId}</if>
            <if test="data.brand != null  and data.brand != ''"> and brand = #{data.brand}</if>
            <if test="data.sku != null  and data.sku != ''"> and sku = #{data.sku}</if>
            <if test="data.category != null  and data.category != ''"> and category = #{data.category}</if>
            <if test="data.feeItem != null  and data.feeItem != ''"> and fee_item = #{data.feeItem}</if>
            <if test="data.amountCny != null "> and amount_cny = #{data.amountCny}</if>
            <if test="data.platformTransactionNumber != null  and data.platformTransactionNumber != ''"> and platform_transaction_number = #{data.platformTransactionNumber}</if>
            <if test="data.limitedSupplyPriceTaskId != null  and data.limitedSupplyPriceTaskId != ''"> and limited_supply_price_task_id = #{data.limitedSupplyPriceTaskId}</if>
            <if test="data.revenue != null "> and revenue = #{data.revenue}</if>
            <if test="data.refund != null "> and refund = #{data.refund}</if>
            <if test="data.allocationRatio != null "> and allocation_ratio = #{data.allocationRatio}</if>
            <if test="data.purchaseCost != null "> and purchase_cost = #{data.purchaseCost}</if>
            <if test="data.firstMileCost != null "> and first_mile_cost = #{data.firstMileCost}</if>
            <if test="data.logisticsFee != null "> and logistics_fee = #{data.logisticsFee}</if>
            <if test="data.packagingCost != null "> and packaging_cost = #{data.packagingCost}</if>
            <if test="data.otherCosts != null "> and other_costs = #{data.otherCosts}</if>
            <if test="data.reshipmentCost != null "> and reshipment_cost = #{data.reshipmentCost}</if>
            <if test="data.grossProfit != null "> and gross_profit = #{data.grossProfit}</if>
            <if test="data.grossProfitMargin != null "> and gross_profit_margin = #{data.grossProfitMargin}</if>
            <if test="data.developer != null  and data.developer != ''"> and developer = #{data.developer}</if>
            <if test="data.operator != null  and data.operator != ''"> and operator = #{data.operator}</if>
            <if test="data.shippingWarehouse != null  and data.shippingWarehouse != ''"> and shipping_warehouse = #{data.shippingWarehouse}</if>

            <!-- 岗位权限数据过滤 -->
            <include refid="postDataFilter"/>
        </where>
    </select>

    <select id="selectOverseasHostingDataById" parameterType="Integer" resultMap="OverseasHostingDataResult">
        <include refid="selectOverseasHostingDataVo"/>
        where id = #{id}
    </select>

    <insert id="insertOverseasHostingData" parameterType="OverseasHostingData" useGeneratedKeys="true" keyProperty="id">
        insert into overseas_hosting_data
        <trim prefix="(" suffix=")" suffixOverrides=",">
            <if test="store != null and store != ''">store,</if>
            <if test="settlementTime != null">settlement_time,</if>
            <if test="orderNumber != null and orderNumber != ''">order_number,</if>
            <if test="productId != null">product_id,</if>
            <if test="brand != null">brand,</if>
            <if test="sku != null">sku,</if>
            <if test="category != null">category,</if>
            <if test="feeItem != null and feeItem != ''">fee_item,</if>
            <if test="amountCny != null">amount_cny,</if>
            <if test="platformTransactionNumber != null">platform_transaction_number,</if>
            <if test="limitedSupplyPriceTaskId != null">limited_supply_price_task_id,</if>
            <if test="revenue != null">revenue,</if>
            <if test="refund != null">refund,</if>
            <if test="allocationRatio != null">allocation_ratio,</if>
            <if test="purchaseCost != null">purchase_cost,</if>
            <if test="firstMileCost != null">first_mile_cost,</if>
            <if test="logisticsFee != null">logistics_fee,</if>
            <if test="packagingCost != null">packaging_cost,</if>
            <if test="otherCosts != null">other_costs,</if>
            <if test="reshipmentCost != null">reshipment_cost,</if>
            <if test="grossProfit != null">gross_profit,</if>
            <if test="grossProfitMargin != null">gross_profit_margin,</if>
            <if test="developer != null">developer,</if>
            <if test="operator != null">operator,</if>
            <if test="shippingWarehouse != null">shipping_warehouse,</if>
        </trim>
        <trim prefix="values (" suffix=")" suffixOverrides=",">
            <if test="store != null and store != ''">#{store},</if>
            <if test="settlementTime != null">#{settlementTime},</if>
            <if test="orderNumber != null and orderNumber != ''">#{orderNumber},</if>
            <if test="productId != null">#{productId},</if>
            <if test="brand != null">#{brand},</if>
            <if test="sku != null">#{sku},</if>
            <if test="category != null">#{category},</if>
            <if test="feeItem != null and feeItem != ''">#{feeItem},</if>
            <if test="amountCny != null">#{amountCny},</if>
            <if test="platformTransactionNumber != null">#{platformTransactionNumber},</if>
            <if test="limitedSupplyPriceTaskId != null">#{limitedSupplyPriceTaskId},</if>
            <if test="revenue != null">#{revenue},</if>
            <if test="refund != null">#{refund},</if>
            <if test="allocationRatio != null">#{allocationRatio},</if>
            <if test="purchaseCost != null">#{purchaseCost},</if>
            <if test="firstMileCost != null">#{firstMileCost},</if>
            <if test="logisticsFee != null">#{logisticsFee},</if>
            <if test="packagingCost != null">#{packagingCost},</if>
            <if test="otherCosts != null">#{otherCosts},</if>
            <if test="reshipmentCost != null">#{reshipmentCost},</if>
            <if test="grossProfit != null">#{grossProfit},</if>
            <if test="grossProfitMargin != null">#{grossProfitMargin},</if>
            <if test="developer != null">#{developer},</if>
            <if test="operator != null">#{operator},</if>
            <if test="shippingWarehouse != null">#{shippingWarehouse},</if>
        </trim>
    </insert>

    <select id="selectOverseasHostingDataByOrderNumbers" resultMap="OverseasHostingDataResult" parameterType="java.util.Set">
        <include refid="selectOverseasHostingDataVo"/>
        where order_number in
        <foreach item="orderNumber" collection="orderNumbers" index="index" open="(" separator="," close=")">
            #{orderNumber}
        </foreach>
    </select>

    <select id="selectOverseasHostingDataByOrderNumberIsNull" resultMap="OverseasHostingDataResult">
        <include refid="selectOverseasHostingDataVo"/>
        where order_number IS NULL
    </select>

    <insert id="batchInsertOverseasHostingData" parameterType="java.util.List">
        insert into overseas_hosting_data
        (
            store,
            settlement_time,
            order_number,
            product_id,
            brand,
            sku,
            category,
            fee_item,
            amount_cny,
            platform_transaction_number,
            limited_supply_price_task_id,
            revenue,
            refund,
            allocation_ratio,
            purchase_cost,
            first_mile_cost,
            logistics_fee,
            packaging_cost,
            other_costs,
            reshipment_cost,
            gross_profit,
            gross_profit_margin,
            developer,
            operator,
            shipping_warehouse
        ) VALUES
        <foreach item="item" collection="list" separator=",">
            (
                #{item.store},
                #{item.settlementTime},
                #{item.orderNumber},
                #{item.productId},
                #{item.brand},
                #{item.sku},
                #{item.category},
                #{item.feeItem},
                #{item.amountCny},
                #{item.platformTransactionNumber},
                #{item.limitedSupplyPriceTaskId},
                #{item.revenue},
                #{item.refund},
                #{item.allocationRatio},
                #{item.purchaseCost},
                #{item.firstMileCost},
                #{item.logisticsFee},
                #{item.packagingCost},
                #{item.otherCosts},
                #{item.reshipmentCost},
                #{item.grossProfit},
                #{item.grossProfitMargin},
                #{item.developer},
                #{item.operator},
                #{item.shippingWarehouse}
            )
        </foreach>
    </insert>

    <update id="updateOverseasHostingData" parameterType="OverseasHostingData">
        update overseas_hosting_data
        <trim prefix="SET" suffixOverrides=",">
            <if test="store != null and store != ''">store = #{store},</if>
            <if test="settlementTime != null">settlement_time = #{settlementTime},</if>
            <if test="orderNumber != null and orderNumber != ''">order_number = #{orderNumber},</if>
            <if test="productId != null">product_id = #{productId},</if>
            <if test="brand != null">brand = #{brand},</if>
            <if test="sku != null">sku = #{sku},</if>
            <if test="category != null">category = #{category},</if>
            <if test="feeItem != null and feeItem != ''">fee_item = #{feeItem},</if>
            <if test="amountCny != null">amount_cny = #{amountCny},</if>
            <if test="platformTransactionNumber != null">platform_transaction_number = #{platformTransactionNumber},</if>
            <if test="limitedSupplyPriceTaskId != null">limited_supply_price_task_id = #{limitedSupplyPriceTaskId},</if>
            <if test="revenue != null">revenue = #{revenue},</if>
            <if test="refund != null">refund = #{refund},</if>
            <if test="allocationRatio != null">allocation_ratio = #{allocationRatio},</if>
            <if test="purchaseCost != null">purchase_cost = #{purchaseCost},</if>
            <if test="firstMileCost != null">first_mile_cost = #{firstMileCost},</if>
            <if test="logisticsFee != null">logistics_fee = #{logisticsFee},</if>
            <if test="packagingCost != null">packaging_cost = #{packagingCost},</if>
            <if test="otherCosts != null">other_costs = #{otherCosts},</if>
            <if test="reshipmentCost != null">reshipment_cost = #{reshipmentCost},</if>
            <if test="grossProfit != null">gross_profit = #{grossProfit},</if>
            <if test="grossProfitMargin != null">gross_profit_margin = #{grossProfitMargin},</if>
            <if test="developer != null">developer = #{developer},</if>
            <if test="operator != null">operator = #{operator},</if>
            <if test="shippingWarehouse != null">shipping_warehouse = #{shippingWarehouse},</if>
        </trim>
        where id = #{id}
    </update>

    <delete id="deleteOverseasHostingDataById" parameterType="Integer">
        delete from overseas_hosting_data where id = #{id}
    </delete>

    <delete id="deleteOverseasHostingDataByIds" parameterType="String">
        delete from overseas_hosting_data where id in
        <foreach item="id" collection="array" open="(" separator="," close=")">
            #{id}
        </foreach>
    </delete>

    <!-- 按运营分组汇总 -->
    <select id="selectSummaryByOperator" resultMap="DimensionSummaryResult">
        SELECT
            operator as group_value,
            COALESCE(SUM(revenue), 0) as revenue_sum,
            COALESCE(SUM(refund), 0) as refund_sum,
            COALESCE(SUM(purchase_cost), 0) as purchase_cost_sum,
            COALESCE(SUM(first_mile_cost), 0) as first_mile_cost_sum,
            COALESCE(SUM(logistics_fee), 0) as logistics_fee_sum,
            COALESCE(SUM(packaging_cost), 0) as packaging_cost_sum,
            COALESCE(SUM(other_costs), 0) as other_costs_sum,
            COALESCE(SUM(reshipment_cost), 0) as reshipment_cost_sum,
            COALESCE(SUM(gross_profit), 0) as gross_profit_sum
        FROM overseas_hosting_data
        <where>
            operator IS NOT NULL AND operator != ''
            <if test="warehouseList != null and warehouseList.size() != 0">
                AND shipping_warehouse IN
                <foreach item="warehouse" collection="warehouseList" open="(" separator="," close=")">
                    #{warehouse}
                </foreach>
            </if>
            <if test="beginSettlementDate != null and beginSettlementDate != ''">
                AND settlement_time &gt;= #{beginSettlementDate}
            </if>
            <if test="endSettlementDate != null and endSettlementDate != ''">
                AND settlement_time &lt;= #{endSettlementDate}
            </if>
            <include refid="postDataFilter"/>
        </where>
        GROUP BY operator
    </select>
    <!-- 按开发员分组汇总 -->
    <select id="selectSummaryByDeveloper" resultMap="DimensionSummaryResult">
        SELECT
            developer as group_value,
            COALESCE(SUM(revenue), 0) as revenue_sum,
            COALESCE(SUM(refund), 0) as refund_sum,
            COALESCE(SUM(purchase_cost), 0) as purchase_cost_sum,
            COALESCE(SUM(first_mile_cost), 0) as first_mile_cost_sum,
            COALESCE(SUM(logistics_fee), 0) as logistics_fee_sum,
            COALESCE(SUM(packaging_cost), 0) as packaging_cost_sum,
            COALESCE(SUM(other_costs), 0) as other_costs_sum,
            COALESCE(SUM(reshipment_cost), 0) as reshipment_cost_sum,
            COALESCE(SUM(gross_profit), 0) as gross_profit_sum
        FROM overseas_hosting_data
        WHERE developer IS NOT NULL AND developer != ''
        <if test="warehouseList != null and warehouseList.size() != 0">
            AND shipping_warehouse IN
            <foreach item="warehouse" collection="warehouseList" open="(" separator="," close=")">
                #{warehouse}
            </foreach>
        </if>
        <if test="beginSettlementDate != null and beginSettlementDate != ''">
            AND settlement_time &gt;= #{beginSettlementDate}
        </if>
        <if test="endSettlementDate != null and endSettlementDate != ''">
            AND settlement_time &lt;= #{endSettlementDate}
        </if>
        <include refid="postDataFilter"/>
        GROUP BY developer
    </select>
    <!-- 按品牌分组汇总 -->
    <select id="selectSummaryByBrand" resultMap="DimensionSummaryResult">
        SELECT
            brand as group_value,
            COALESCE(SUM(revenue), 0) as revenue_sum,
            COALESCE(SUM(refund), 0) as refund_sum,
            COALESCE(SUM(purchase_cost), 0) as purchase_cost_sum,
            COALESCE(SUM(first_mile_cost), 0) as first_mile_cost_sum,
            COALESCE(SUM(logistics_fee), 0) as logistics_fee_sum,
            COALESCE(SUM(packaging_cost), 0) as packaging_cost_sum,
            COALESCE(SUM(other_costs), 0) as other_costs_sum,
            COALESCE(SUM(reshipment_cost), 0) as reshipment_cost_sum,
            COALESCE(SUM(gross_profit), 0) as gross_profit_sum
        FROM overseas_hosting_data
        WHERE brand IS NOT NULL AND brand != ''
        <if test="warehouseList != null and warehouseList.size() != 0">
            AND shipping_warehouse IN
            <foreach item="warehouse" collection="warehouseList" open="(" separator="," close=")">
                #{warehouse}
            </foreach>
        </if>
        <if test="beginSettlementDate != null and beginSettlementDate != ''">
            AND settlement_time &gt;= #{beginSettlementDate}
        </if>
        <if test="endSettlementDate != null and endSettlementDate != ''">
            AND settlement_time &lt;= #{endSettlementDate}
        </if>
        <include refid="postDataFilter"/>
        GROUP BY brand
    </select>
    <!-- 按仓库分组汇总 -->
    <select id="selectSummaryByWarehouse" resultMap="DimensionSummaryResult">
        SELECT
            shipping_warehouse as group_value,
            COALESCE(SUM(revenue), 0) as revenue_sum,
            COALESCE(SUM(refund), 0) as refund_sum,
            COALESCE(SUM(purchase_cost), 0) as purchase_cost_sum,
            COALESCE(SUM(first_mile_cost), 0) as first_mile_cost_sum,
            COALESCE(SUM(logistics_fee), 0) as logistics_fee_sum,
            COALESCE(SUM(packaging_cost), 0) as packaging_cost_sum,
            COALESCE(SUM(other_costs), 0) as other_costs_sum,
            COALESCE(SUM(reshipment_cost), 0) as reshipment_cost_sum,
            COALESCE(SUM(gross_profit), 0) as gross_profit_sum
        FROM overseas_hosting_data
        WHERE shipping_warehouse IS NOT NULL AND shipping_warehouse != ''
        <if test="warehouseList != null and warehouseList.size() != 0">
            AND shipping_warehouse IN
            <foreach item="warehouse" collection="warehouseList" open="(" separator="," close=")">
                #{warehouse}
            </foreach>
        </if>
        <if test="beginSettlementDate != null and beginSettlementDate != ''">
            AND settlement_time &gt;= #{beginSettlementDate}
        </if>
        <if test="endSettlementDate != null and endSettlementDate != ''">
            AND settlement_time &lt;= #{endSettlementDate}
        </if>
        <include refid="postDataFilter"/>
        GROUP BY shipping_warehouse
    </select>
    <!-- 按类目分组汇总 -->
    <select id="selectSummaryByCategory" resultMap="DimensionSummaryResult">
        SELECT
            category as group_value,
            COALESCE(SUM(revenue), 0) as revenue_sum,
            COALESCE(SUM(refund), 0) as refund_sum,
            COALESCE(SUM(purchase_cost), 0) as purchase_cost_sum,
            COALESCE(SUM(first_mile_cost), 0) as first_mile_cost_sum,
            COALESCE(SUM(logistics_fee), 0) as logistics_fee_sum,
            COALESCE(SUM(packaging_cost), 0) as packaging_cost_sum,
            COALESCE(SUM(other_costs), 0) as other_costs_sum,
            COALESCE(SUM(reshipment_cost), 0) as reshipment_cost_sum,
            COALESCE(SUM(gross_profit), 0) as gross_profit_sum
        FROM overseas_hosting_data
        WHERE category IS NOT NULL AND category != ''
        <if test="warehouseList != null and warehouseList.size() != 0">
            AND shipping_warehouse IN
            <foreach item="warehouse" collection="warehouseList" open="(" separator="," close=")">
                #{warehouse}
            </foreach>
        </if>
        <if test="beginSettlementDate != null and beginSettlementDate != ''">
            AND settlement_time &gt;= #{beginSettlementDate}
        </if>
        <if test="endSettlementDate != null and endSettlementDate != ''">
            AND settlement_time &lt;= #{endSettlementDate}
        </if>
        <include refid="postDataFilter"/>
        GROUP BY category
    </select>
    <!-- 按SKU分组汇总 -->
    <select id="selectSummaryBySku" resultMap="DimensionSummaryResult">
        SELECT
            sku as group_value,
            COALESCE(SUM(revenue), 0) as revenue_sum,
            COALESCE(SUM(refund), 0) as refund_sum,
            COALESCE(SUM(purchase_cost), 0) as purchase_cost_sum,
            COALESCE(SUM(first_mile_cost), 0) as first_mile_cost_sum,
            COALESCE(SUM(logistics_fee), 0) as logistics_fee_sum,
            COALESCE(SUM(packaging_cost), 0) as packaging_cost_sum,
            COALESCE(SUM(other_costs), 0) as other_costs_sum,
            COALESCE(SUM(reshipment_cost), 0) as reshipment_cost_sum,
            COALESCE(SUM(gross_profit), 0) as gross_profit_sum
        FROM overseas_hosting_data
        WHERE sku IS NOT NULL AND sku != ''
        <if test="warehouseList != null and warehouseList.size() != 0">
            AND shipping_warehouse IN
            <foreach item="warehouse" collection="warehouseList" open="(" separator="," close=")">
                #{warehouse}
            </foreach>
        </if>
        <if test="beginSettlementDate != null and beginSettlementDate != ''">
            AND settlement_time &gt;= #{beginSettlementDate}
        </if>
        <if test="endSettlementDate != null and endSettlementDate != ''">
            AND settlement_time &lt;= #{endSettlementDate}
        </if>
        <include refid="postDataFilter"/>
        GROUP BY sku
    </select>
    <!-- 按费用项分组汇总金额 -->
    <select id="selectSummaryByFeeItem" resultMap="FeeItemSummaryResult">
        SELECT
            fee_item,
            COALESCE(SUM(amount_cny), 0) as amount_cny_sum
        FROM overseas_hosting_data
        WHERE fee_item IS NOT NULL AND fee_item != ''
        <if test="warehouseList != null and warehouseList.size() != 0">
            AND shipping_warehouse IN
            <foreach item="warehouse" collection="warehouseList" open="(" separator="," close=")">
                #{warehouse}
            </foreach>
        </if>
        <if test="beginSettlementDate != null and beginSettlementDate != ''">
            AND settlement_time &gt;= #{beginSettlementDate}
        </if>
        <if test="endSettlementDate != null and endSettlementDate != ''">
            AND settlement_time &lt;= #{endSettlementDate}
        </if>
        <include refid="postDataFilter"/>
        GROUP BY fee_item
    </select>
    <!-- 按品牌和类目分组汇总数据 -->
    <select id="selectSummaryByBrandAndCategory" resultType="java.util.Map">
        SELECT
            brand,
            category,
            COALESCE(SUM(revenue), 0) as revenue_sum,
            COALESCE(SUM(refund), 0) as refund_sum,
            COALESCE(SUM(purchase_cost), 0) as purchase_cost_sum,
            COALESCE(SUM(first_mile_cost), 0) as first_mile_cost_sum,
            COALESCE(SUM(logistics_fee), 0) as logistics_fee_sum,
            COALESCE(SUM(packaging_cost), 0) as packaging_cost_sum,
            COALESCE(SUM(other_costs), 0) as other_costs_sum,
            COALESCE(SUM(reshipment_cost), 0) as reshipment_cost_sum,
            COALESCE(SUM(gross_profit), 0) as gross_profit_sum
        FROM overseas_hosting_data
        WHERE
            brand IS NOT NULL AND brand != ''
          AND
            category IS NOT NULL AND category != ''
        <if test="warehouseList != null and warehouseList.size() != 0">
            AND shipping_warehouse IN
            <foreach item="warehouse" collection="warehouseList" open="(" separator="," close=")">
                #{warehouse}
            </foreach>
        </if>
        <if test="beginSettlementDate != null and beginSettlementDate != ''">
            AND settlement_time &gt;= #{beginSettlementDate}
        </if>
        <if test="endSettlementDate != null and endSettlementDate != ''">
            AND settlement_time &lt;= #{endSettlementDate}
        </if>
        <include refid="postDataFilter"/>
        GROUP BY brand, category
    </select>
    <!-- 按月份分组汇总当前年份数据 -->
    <select id="selectSummaryByMonthly" resultType="java.util.Map">
        SELECT
            DATE_FORMAT(settlement_time, '%Y-%m') as month,
            COALESCE(SUM(revenue), 0) as revenue_sum,
            COALESCE(SUM(refund), 0) as refund_sum,
            COALESCE(SUM(gross_profit), 0) as gross_profit_sum
        FROM overseas_hosting_data
        WHERE
            settlement_time IS NOT NULL
          AND
            YEAR(settlement_time) = YEAR(CURDATE())
        <if test="warehouseList != null and warehouseList.size() != 0">
            AND shipping_warehouse IN
            <foreach item="warehouse" collection="warehouseList" open="(" separator="," close=")">
                #{warehouse}
            </foreach>
        </if>
        <if test="beginSettlementDate != null and beginSettlementDate != ''">
            AND settlement_time &gt;= #{beginSettlementDate}
        </if>
        <if test="endSettlementDate != null and endSettlementDate != ''">
            AND settlement_time &lt;= #{endSettlementDate}
        </if>
        <include refid="postDataFilter"/>
        GROUP BY DATE_FORMAT(settlement_time, '%Y-%m')
        ORDER BY month
    </select>
    <!-- 获取总体统计数据 -->
    <select id="selectSummaryByTotal" resultType="java.util.Map">
        SELECT
            COALESCE(SUM(revenue), 0) as total_revenue,
            COALESCE(SUM(refund), 0) as total_refund,
            COALESCE(SUM(purchase_cost), 0) as total_purchase_cost,
            COALESCE(SUM(first_mile_cost), 0) as total_first_mile_cost,
            COALESCE(SUM(logistics_fee), 0) as total_logistics_fee,
            COALESCE(SUM(packaging_cost), 0) as total_packaging_cost,
            COALESCE(SUM(other_costs), 0) as total_other_costs,
            COALESCE(SUM(reshipment_cost), 0) as total_reshipment_cost,
            COALESCE(SUM(gross_profit), 0) as total_gross_profit,
            COUNT(1) as total_orders,
            CASE
                WHEN COALESCE(SUM(revenue), 0) &gt; 0
                    THEN ROUND((COALESCE(SUM(gross_profit), 0) / COALESCE(SUM(revenue), 0)) * 100, 2)
                ELSE 0
                END as gross_profit_margin
        FROM overseas_hosting_data
        WHERE revenue IS NOT NULL
        <if test="warehouseList != null and warehouseList.size() != 0">
            AND shipping_warehouse IN
            <foreach item="warehouse" collection="warehouseList" open="(" separator="," close=")">
                #{warehouse}
            </foreach>
        </if>
        <if test="beginSettlementDate != null and beginSettlementDate != ''">
            AND settlement_time &gt;= #{beginSettlementDate}
        </if>
        <if test="endSettlementDate != null and endSettlementDate != ''">
            AND settlement_time &lt;= #{endSettlementDate}
        </if>
        <include refid="postDataFilter"/>
    </select>
    <!-- 获取核心费用项汇总数据 -->
    <select id="selectSummaryByCoreExpenses" resultType="java.util.Map">
        SELECT
            COALESCE(SUM(revenue), 0) as revenue,
            COALESCE(SUM(refund), 0) as refund,
            COALESCE(SUM(purchase_cost), 0) as purchase_cost,
            COALESCE(SUM(first_mile_cost), 0) as first_mile_cost,
            COALESCE(SUM(logistics_fee), 0) as logistics_fee,
            COALESCE(SUM(packaging_cost), 0) as packaging_cost,
            COALESCE(SUM(other_costs), 0) as other_costs,
            COALESCE(SUM(gross_profit), 0) as gross_profit
        FROM overseas_hosting_data
        <where>
            <if test="warehouseList != null and warehouseList.size() != 0">
                shipping_warehouse IN
                <foreach item="warehouse" collection="warehouseList" open="(" separator="," close=")">
                    #{warehouse}
                </foreach>
            </if>
            <if test="beginSettlementDate != null and beginSettlementDate != ''">
                AND settlement_time &gt;= #{beginSettlementDate}
            </if>
            <if test="endSettlementDate != null and endSettlementDate != ''">
                AND settlement_time &lt;= #{endSettlementDate}
            </if>
            <include refid="postDataFilter"/>
        </where>
    </select>
    <select id="selectWarehouse" resultType="java.lang.String">
        SELECT DISTINCT shipping_warehouse FROM overseas_hosting_data WHERE shipping_warehouse IS NOT NULL
    </select>

    <sql id="postDataFilter">
        <!-- 数据权限过滤条件 -->
        <if test="user != null">
            <choose>
                <!-- 超级管理员显示所有数据 -->
                <when test="roleKeys.size() > 0 and roleKeys.contains('admin')">
                </when>
                <!-- 如果是大组长，不限制数据 -->
                <when test="postCodes != null and postCodes.contains('general_leader')">
                </when>
                <!-- 如果有特定岗位，按岗位限制数据 -->
                <when test="postCodes != null and postCodes.size() > 0">
                    <!-- 只对特定岗位进行数据限制 -->
                    <choose>
                        <!-- 组长级别：查看本组数据 -->
                        <when test="postCodes.contains('operation_leader') or postCodes.contains('development_leader')">
                            <!-- 由于TEMU数据中没有运营组和开发组字段，暂时使用操作员和开发员字段进行近似过滤 -->
                            and (
                            <if test="postCodes.contains('operation_leader') and user.operationGroupName != null and user.operationGroupName != ''">
                                operator in (select user_name from sys_user where operation_group_name = #{user.operationGroupName})
                            </if>
                            <if test="postCodes.contains('operation_leader') and postCodes.contains('development_leader') and user.operationGroupName != null and user.operationGroupName != '' and user.developmentGroupName != null and user.developmentGroupName != ''"> OR </if>
                            <if test="postCodes.contains('development_leader') and user.developmentGroupName != null and user.developmentGroupName != ''">
                                developer in (select user_name from sys_user where development_group_name = #{user.developmentGroupName})
                            </if>
                            )
                        </when>
                        <!-- 普通员工：查看自己的数据 -->
                        <when test="(postCodes.contains('operator') or postCodes.contains('developer')) and user.userName != null and user.userName != ''">
                            and (
                            <if test="postCodes.contains('operator') and user.userName != null and user.userName != ''">
                                operator = #{user.userName}
                            </if>
                            <if test="postCodes.contains('operator') and postCodes.contains('developer') and user.userName != null and user.userName != ''"> OR </if>
                            <if test="postCodes.contains('developer') and user.userName != null and user.userName != ''">
                                developer = #{user.userName}
                            </if>
                            )
                        </when>
                        <!-- 其他岗位不限制 -->
                        <otherwise>
                        </otherwise>
                    </choose>
                </when>
                <!-- 防止用户随便增加一些董事长，经理之类的岗位，直接放行权限 -->
                <otherwise>
                </otherwise>
            </choose>
        </if>
    </sql>
</mapper>
