<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.ruoyi.sales.mapper.TEMUVisualizationMapper" >

    <!-- 核心KPI数据查询 -->
    <select id="selectKpiData" parameterType="com.ruoyi.sales.dto.TEMUVisualQuery" resultType="java.util.Map">
        SELECT
        COALESCE(SUM(income_cny), 0) as totalIncome,
        COALESCE(SUM(gross_profit), 0) as totalGrossProfit,
        COALESCE(SUM(td_actual_gross_profit), 0) as totalTdActualGrossProfit,
        COALESCE(AVG(gross_profit_rate), 0) as avgGrossProfitRate,
        CASE
        WHEN COALESCE(SUM(income_cny), 0) = 0 THEN 0
        ELSE COALESCE(SUM(refund_amount), 0) / COALESCE(SUM(income_cny), 0)
        END as refundRatio,
        CASE
        WHEN COALESCE(SUM(income_cny), 0) = 0 THEN 0
        ELSE COALESCE(SUM(product_cost), 0) / COALESCE(SUM(income_cny), 0)
        END as costRatio,
        COUNT(DISTINCT order_number) as totalOrders,
        COALESCE(SUM(shipment_quantity), 0) as totalShipmentQuantity
        FROM temu_order_details
        <where>
            <include refid="visualWhereCondition"/>
            <include refid="selectDataFilter"/>
        </where>
    </select>

    <!-- 平均指标查询 -->
    <select id="selectAverageMetrics" parameterType="com.ruoyi.sales.dto.TEMUVisualQuery" resultType="java.util.Map">
        SELECT
        CASE
        WHEN COALESCE(SUM(income_cny), 0) = 0 THEN 0
        ELSE COALESCE(SUM(refund_amount), 0) / COALESCE(SUM(income_cny), 0)
        END as averageRefundRate,
        COALESCE(AVG(gross_profit_rate), 0) as averageGrossProfitRate,
        COUNT(DISTINCT order_number) as totalOrders,
        COALESCE(SUM(income_cny), 0) as totalIncome,
        COALESCE(SUM(refund_amount), 0) as totalRefundAmount
        FROM temu_order_details
        <where>
            <include refid="visualWhereCondition"/>
            <include refid="selectDataFilter"/>
        </where>
    </select>

    <!-- 预警数据 -->
    <select id="selectAlertData" parameterType="com.ruoyi.sales.dto.TEMUVisualQuery" resultType="java.util.Map">
        SELECT
        '高退款率' as alertType,
        category as item,
        CASE
        WHEN COALESCE(SUM(income_cny), 0) = 0 THEN 0
        ELSE COALESCE(SUM(refund_amount), 0) / COALESCE(SUM(income_cny), 0)
        END as value
        FROM temu_order_details
        <where>
            <include refid="visualWhereCondition"/>
            AND category IS NOT NULL
        </where>
        GROUP BY category
        HAVING value &gt; 0.1

        UNION ALL

        SELECT
        '负毛利产品' as alertType,
        product_name as item,
        COALESCE(SUM(td_actual_gross_profit), 0) as value
        FROM temu_order_details
        <where>
            <include refid="visualWhereCondition"/>
            AND product_name IS NOT NULL
            <include refid="selectDataFilter"/>
        </where>
        GROUP BY product_name
        HAVING value &lt; 0
    </select>

    <!-- 筛选选项 -->
    <select id="selectFilterOptions" resultType="java.util.Map">
        SELECT
            GROUP_CONCAT(DISTINCT DATE_FORMAT(payment_date, '%Y-%m-%d') ORDER BY payment_date DESC) as dates,
            GROUP_CONCAT(DISTINCT category) as categories,
            GROUP_CONCAT(DISTINCT developer) as developers,
            GROUP_CONCAT(DISTINCT operator) as operators,
            GROUP_CONCAT(DISTINCT country_region) as countries
        FROM temu_order_details
        WHERE payment_date IS NOT NULL
    </select>

    <!-- 运营员透视数据 -->
    <select id="selectOperatorPerspectiveData" parameterType="com.ruoyi.sales.dto.TEMUVisualQuery" resultType="java.util.Map">
        SELECT
        operator as groupName,
        COALESCE(SUM(income_cny), 0) as income,
        COALESCE(SUM(refund_amount), 0) as refundAmount,
        COALESCE(SUM(product_cost), 0) as productCost,
        COALESCE(SUM(first_leg_cost), 0) as firstLegCost,
        COALESCE(SUM(channel_fee_cny), 0) as channelFee,
        COALESCE(SUM(logistics_shipping_cost), 0) as logisticsShippingCost,
        COALESCE(SUM(us_platform_label_fee), 0) as usPlatformLabelFee,
        COALESCE(SUM(other_costs), 0) as otherCosts,
        COALESCE(SUM(backend_refund_subsidy), 0) as backendRefundSubsidy,
        COALESCE(SUM(advertising_fee), 0) as advertisingFee,
        COALESCE(SUM(replenishment_cost), 0) as replenishmentCost,
        COALESCE(SUM(packaging_cost), 0) as packagingCost,
        COALESCE(SUM(clearance_subsidy), 0) as clearanceSubsidy,
        COALESCE(SUM(gross_profit), 0) as grossProfit,
        CASE WHEN COALESCE(SUM(income_cny), 0) = 0 THEN 0 ELSE COALESCE(SUM(gross_profit), 0) / COALESCE(SUM(income_cny), 0) END as grossProfitRate,
        COALESCE(SUM(distribution_commission), 0) as distributionCommission,
        COALESCE(SUM(td_actual_gross_profit), 0) as tdActualGrossProfit,
        CASE WHEN COALESCE(SUM(income_cny), 0) = 0 THEN 0 ELSE COALESCE(SUM(td_actual_gross_profit), 0) / COALESCE(SUM(income_cny), 0) END as tdActualGrossProfitRate,
        CASE WHEN COALESCE(SUM(income_cny), 0) = 0 THEN 0 ELSE COALESCE(SUM(product_cost), 0) / COALESCE(SUM(income_cny), 0) END as productCostRatio,
        CASE WHEN COALESCE(SUM(income_cny), 0) = 0 THEN 0 ELSE COALESCE(SUM(first_leg_cost), 0) / COALESCE(SUM(income_cny), 0) END as firstLegCostRatio,
        CASE WHEN COALESCE(SUM(income_cny), 0) = 0 THEN 0 ELSE COALESCE(SUM(logistics_shipping_cost), 0) / COALESCE(SUM(income_cny), 0) END as logisticsShippingCostRatio,
        CASE WHEN COALESCE(SUM(income_cny), 0) = 0 THEN 0 ELSE COALESCE(SUM(refund_amount), 0) / COALESCE(SUM(income_cny), 0) END as refundRatio,
        CASE WHEN COALESCE(SUM(income_cny), 0) = 0 THEN 0 ELSE COALESCE(SUM(replenishment_cost), 0) / COALESCE(SUM(income_cny), 0) END as replenishmentCostRatio
        FROM temu_order_details
        <where>
            <include refid="visualWhereCondition"/>
            AND operator IS NOT NULL
            <include refid="selectDataFilter"/>
        </where>
        GROUP BY operator
        <if test="query.sortField != null and query.sortField != '' and query.sortOrder != null and query.sortOrder != ''">
            ORDER BY ${query.sortField} ${query.sortOrder}
        </if>
        <if test="query.sortField == null or query.sortField == ''">
            ORDER BY income DESC
        </if>
    </select>

    <!-- 开发员透视数据 -->
    <select id="selectDeveloperPerspectiveData" parameterType="com.ruoyi.sales.dto.TEMUVisualQuery" resultType="java.util.Map">
        SELECT
        developer as groupName,
        COALESCE(SUM(income_cny), 0) as income,
        COALESCE(SUM(refund_amount), 0) as refundAmount,
        COALESCE(SUM(product_cost), 0) as productCost,
        COALESCE(SUM(first_leg_cost), 0) as firstLegCost,
        COALESCE(SUM(channel_fee_cny), 0) as channelFee,
        COALESCE(SUM(logistics_shipping_cost), 0) as logisticsShippingCost,
        COALESCE(SUM(other_costs), 0) as otherCosts,
        COALESCE(SUM(backend_refund_subsidy), 0) as backendRefundSubsidy,
        COALESCE(SUM(advertising_fee), 0) as advertisingFee,
        COALESCE(SUM(replenishment_cost), 0) as replenishmentCost,
        COALESCE(SUM(packaging_cost), 0) as packagingCost,
        COALESCE(SUM(clearance_subsidy), 0) as clearanceSubsidy,
        COALESCE(SUM(gross_profit), 0) as grossProfit,
        COALESCE(SUM(distribution_commission), 0) as distributionCommission,
        COALESCE(SUM(td_actual_gross_profit), 0) as tdActualGrossProfit
        FROM temu_order_details
        <where>
            <include refid="visualWhereCondition"/>
            AND developer IS NOT NULL
            <include refid="selectDataFilter"/>
        </where>
        GROUP BY developer
        <if test="query.sortField != null and query.sortField != '' and query.sortOrder != null and query.sortOrder != ''">
            ORDER BY ${query.sortField} ${query.sortOrder}
        </if>
        <if test="query.sortField == null or query.sortField == ''">
            ORDER BY income DESC
        </if>
    </select>

    <!-- 品类透视数据 -->
    <select id="selectCategoryPerspectiveData" parameterType="com.ruoyi.sales.dto.TEMUVisualQuery" resultType="java.util.Map">
        SELECT
        category as groupName,
        COALESCE(SUM(income_cny), 0) as income,
        COALESCE(SUM(refund_amount), 0) as refundAmount,
        COALESCE(SUM(product_cost), 0) as productCost,
        COALESCE(SUM(first_leg_cost), 0) as firstLegCost,
        COALESCE(SUM(channel_fee_cny), 0) as channelFee,
        COALESCE(SUM(logistics_shipping_cost), 0) as logisticsShippingCost,
        COALESCE(SUM(us_platform_label_fee), 0) as usPlatformLabelFee,
        COALESCE(SUM(other_costs), 0) as otherCosts,
        COALESCE(SUM(backend_refund_subsidy), 0) as backendRefundSubsidy,
        COALESCE(SUM(advertising_fee), 0) as advertisingFee,
        COALESCE(SUM(replenishment_cost), 0) as replenishmentCost,
        COALESCE(SUM(packaging_cost), 0) as packagingCost,
        COALESCE(SUM(clearance_subsidy), 0) as clearanceSubsidy,
        COALESCE(SUM(gross_profit), 0) as grossProfit,
        CASE WHEN COALESCE(SUM(income_cny), 0) = 0 THEN 0 ELSE COALESCE(SUM(gross_profit), 0) / COALESCE(SUM(income_cny), 0) END as grossProfitRate,
        COALESCE(SUM(distribution_commission), 0) as distributionCommission,
        COALESCE(SUM(td_actual_gross_profit), 0) as tdActualGrossProfit,
        CASE WHEN COALESCE(SUM(income_cny), 0) = 0 THEN 0 ELSE COALESCE(SUM(td_actual_gross_profit), 0) / COALESCE(SUM(income_cny), 0) END as tdActualGrossProfitRate,
        CASE WHEN COALESCE(SUM(income_cny), 0) = 0 THEN 0 ELSE COALESCE(SUM(product_cost), 0) / COALESCE(SUM(income_cny), 0) END as productCostRatio,
        CASE WHEN COALESCE(SUM(income_cny), 0) = 0 THEN 0 ELSE COALESCE(SUM(first_leg_cost), 0) / COALESCE(SUM(income_cny), 0) END as firstLegCostRatio,
        CASE WHEN COALESCE(SUM(income_cny), 0) = 0 THEN 0 ELSE COALESCE(SUM(logistics_shipping_cost), 0) / COALESCE(SUM(income_cny), 0) END as logisticsShippingCostRatio,
        CASE WHEN COALESCE(SUM(income_cny), 0) = 0 THEN 0 ELSE COALESCE(SUM(refund_amount), 0) / COALESCE(SUM(income_cny), 0) END as refundRatio,
        CASE WHEN COALESCE(SUM(income_cny), 0) = 0 THEN 0 ELSE COALESCE(SUM(replenishment_cost), 0) / COALESCE(SUM(income_cny), 0) END as replenishmentCostRatio
        FROM temu_order_details
        <where>
            <include refid="visualWhereCondition"/>
            AND category IS NOT NULL
            <include refid="selectDataFilter"/>
        </where>
        GROUP BY category
        <if test="query.sortField != null and query.sortField != '' and query.sortOrder != null and query.sortOrder != ''">
            ORDER BY ${query.sortField} ${query.sortOrder}
        </if>
        <if test="query.sortField == null or query.sortField == ''">
            ORDER BY income DESC
        </if>
    </select>

    <!-- 运营员发货仓库数据 -->
    <select id="selectOperatorWarehouseData" parameterType="com.ruoyi.sales.dto.TEMUVisualQuery" resultType="java.util.Map">
        SELECT
        operator as groupName,
        shipment_warehouse as warehouseName,
        COALESCE(SUM(income_cny), 0) as income,
        COALESCE(SUM(refund_amount), 0) as refundAmount,
        COALESCE(SUM(product_cost), 0) as productCost,
        COALESCE(SUM(first_leg_cost), 0) as firstLegCost,
        COALESCE(SUM(channel_fee_cny), 0) as channelFee,
        COALESCE(SUM(logistics_shipping_cost), 0) as logisticsShippingCost,
        COALESCE(SUM(us_platform_label_fee), 0) as usPlatformLabelFee,
        COALESCE(SUM(other_costs), 0) as otherCosts,
        COALESCE(SUM(backend_refund_subsidy), 0) as backendRefundSubsidy,
        COALESCE(SUM(advertising_fee), 0) as advertisingFee,
        COALESCE(SUM(replenishment_cost), 0) as replenishmentCost,
        COALESCE(SUM(packaging_cost), 0) as packagingCost,
        COALESCE(SUM(clearance_subsidy), 0) as clearanceSubsidy,
        COALESCE(SUM(gross_profit), 0) as grossProfit,
        CASE WHEN COALESCE(SUM(income_cny), 0) = 0 THEN 0 ELSE COALESCE(SUM(gross_profit), 0) / COALESCE(SUM(income_cny), 0) END as grossProfitRate,
        COALESCE(SUM(distribution_commission), 0) as distributionCommission,
        COALESCE(SUM(td_actual_gross_profit), 0) as tdActualGrossProfit,
        CASE WHEN COALESCE(SUM(income_cny), 0) = 0 THEN 0 ELSE COALESCE(SUM(td_actual_gross_profit), 0) / COALESCE(SUM(income_cny), 0) END as tdActualGrossProfitRate,
        CASE WHEN COALESCE(SUM(income_cny), 0) = 0 THEN 0 ELSE COALESCE(SUM(product_cost), 0) / COALESCE(SUM(income_cny), 0) END as productCostRatio,
        CASE WHEN COALESCE(SUM(income_cny), 0) = 0 THEN 0 ELSE COALESCE(SUM(first_leg_cost), 0) / COALESCE(SUM(income_cny), 0) END as firstLegCostRatio,
        CASE WHEN COALESCE(SUM(income_cny), 0) = 0 THEN 0 ELSE COALESCE(SUM(logistics_shipping_cost), 0) / COALESCE(SUM(income_cny), 0) END as logisticsShippingCostRatio,
        CASE WHEN COALESCE(SUM(income_cny), 0) = 0 THEN 0 ELSE COALESCE(SUM(refund_amount), 0) / COALESCE(SUM(income_cny), 0) END as refundRatio,
        CASE WHEN COALESCE(SUM(income_cny), 0) = 0 THEN 0 ELSE COALESCE(SUM(replenishment_cost), 0) / COALESCE(SUM(income_cny), 0) END as replenishmentCostRatio
        FROM temu_order_details
        <where>
            <include refid="visualWhereCondition"/>
            AND operator IS NOT NULL
            AND shipment_warehouse IS NOT NULL
            <include refid="selectDataFilter"/>
        </where>
        GROUP BY operator, shipment_warehouse
    </select>

    <!-- 运营员发货仓库数据 -->
    <select id="selectDeveloperWarehouseData" parameterType="com.ruoyi.sales.dto.TEMUVisualQuery" resultType="java.util.Map">
        SELECT
        developer as groupName,
        shipment_warehouse as warehouseName,
        COALESCE(SUM(income_cny), 0) as income,
        COALESCE(SUM(refund_amount), 0) as refundAmount,
        COALESCE(SUM(product_cost), 0) as productCost,
        COALESCE(SUM(first_leg_cost), 0) as firstLegCost,
        COALESCE(SUM(channel_fee_cny), 0) as channelFee,
        COALESCE(SUM(logistics_shipping_cost), 0) as logisticsShippingCost,
        COALESCE(SUM(other_costs), 0) as otherCosts,
        COALESCE(SUM(backend_refund_subsidy), 0) as backendRefundSubsidy,
        COALESCE(SUM(advertising_fee), 0) as advertisingFee,
        COALESCE(SUM(replenishment_cost), 0) as replenishmentCost,
        COALESCE(SUM(packaging_cost), 0) as packagingCost,
        COALESCE(SUM(clearance_subsidy), 0) as clearanceSubsidy,
        COALESCE(SUM(gross_profit), 0) as grossProfit,
        COALESCE(SUM(distribution_commission), 0) as distributionCommission,
        COALESCE(SUM(td_actual_gross_profit), 0) as tdActualGrossProfit
        FROM temu_order_details
        <where>
            <include refid="visualWhereCondition"/>
            AND developer IS NOT NULL
            AND shipment_warehouse IS NOT NULL
            <include refid="selectDataFilter"/>
        </where>
        GROUP BY developer, shipment_warehouse
    </select>

    <!-- 查询条件 -->
    <sql id="visualWhereCondition">
        <if test="query.startDate != null"> AND payment_date >= #{query.startDate}</if>
        <if test="query.endDate != null"> AND payment_date &lt;= #{query.endDate}</if>
        <if test="query.category != null and category != ''"> AND category = #{query.category}</if>
        <if test="query.developer != null and developer != ''"> AND developer = #{query.developer}</if>
        <if test="query.operator != null and operator != ''"> AND operator = #{query.operator}</if>
        <if test="query.countryRegion != null and countryRegion != ''"> AND country_region = #{query.countryRegion}</if>
    </sql>

    <!-- 数据过滤条件 -->
    <sql id="selectDataFilter">
        <!-- 数据权限过滤条件 -->
        <if test="user != null">
            <choose>
                <!-- 超级管理员显示所有数据 -->
                <when test="roleKeys.size() > 0 and roleKeys.contains('admin')">
                </when>
                <!-- 如果是大组长，不限制数据 -->
                <when test="postCodes != null and postCodes.contains('general_leader')">
                </when>
                <!-- 如果有岗位但不是大组长 -->
                <when test="postCodes != null and postCodes.size() > 0">
                    and (
                    <choose>
                        <!-- 组长级别：查看本组数据 -->
                        <when test="postCodes.contains('operation_leader') or postCodes.contains('development_leader')">
                            <!-- 由于TEMU数据中没有运营组和开发组字段，暂时使用操作员和开发员字段进行近似过滤 -->
                            <if test="postCodes.contains('operation_leader') and user.operationGroupName != null and user.operationGroupName != ''">
                                operator in (select user_name from sys_user where operation_group_name = #{user.operationGroupName})
                            </if>
                            <if test="postCodes.contains('operation_leader') and postCodes.contains('development_leader') and user.operationGroupName != null and user.operationGroupName != '' and user.developmentGroupName != null and user.developmentGroupName != ''"> OR </if>
                            <if test="postCodes.contains('development_leader') and user.developmentGroupName != null and user.developmentGroupName != ''">
                                developer in (select user_name from sys_user where development_group_name = #{user.developmentGroupName})
                            </if>
                        </when>
                        <!-- 普通员工：查看自己的数据 -->
                        <otherwise>
                            <if test="postCodes.contains('operator') and user.userName != null and user.userName != ''">
                                operator = #{user.userName}
                            </if>
                            <if test="postCodes.contains('operator') and postCodes.contains('developer') and user.userName != null and user.userName != ''"> OR </if>
                            <if test="postCodes.contains('developer') and user.userName != null and user.userName != ''">
                                developer = #{user.userName}
                            </if>
                        </otherwise>
                    </choose>
                    )
                </when>
                <!-- 防止用户随便增加一些董事长，经理之类的岗位，直接放行权限 -->
                <otherwise>
                </otherwise>
            </choose>
        </if>
    </sql>
</mapper>
